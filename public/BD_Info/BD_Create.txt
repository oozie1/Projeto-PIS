DROP SCHEMA IF EXISTS `BD_ProjetoPIS`;
CREATE SCHEMA `BD_ProjetoPIS`;
USE `BD_ProjetoPIS`;

-- Nao se esquecam que este nome é o nome da base de dados

CREATE TABLE `Utilizadores` (
  `id_utilizador` INT NOT NULL AUTO_INCREMENT,
  `nome_utilizador` VARCHAR(100) NOT NULL,
  `email` VARCHAR(100) NOT NULL UNIQUE,
  `password_hash` VARCHAR(255) NOT NULL,
  `data_registo` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `is_admin` BOOLEAN NOT NULL DEFAULT FALSE,
  PRIMARY KEY (`id_utilizador`)
);

CREATE TABLE `Generos` (
  `id_genero` INT NOT NULL AUTO_INCREMENT,
  `nome_genero` VARCHAR(50) NOT NULL UNIQUE,
  PRIMARY KEY (`id_genero`)
);

CREATE TABLE `Conteudo` (
  `id_conteudo` INT NOT NULL AUTO_INCREMENT,
  `tipo` ENUM('Filme', 'Serie') NOT NULL,
  `nome` VARCHAR(255) NOT NULL,
  `sinopse` TEXT NULL,
  `duracao_minutos` INT NULL,
  `ano_lancamento` YEAR NULL,
  `nome_diretor` VARCHAR(150) NULL, 
  `id_genero` INT NULL, -- O conteúdo tem UM género (FK)
  `elenco_principal_nomes` TEXT NULL, -- Lista de Atores como texto
  `poster_url` VARCHAR(255) NULL,
  `trailer_url` VARCHAR(255) NULL,
  PRIMARY KEY (`id_conteudo`),
  FOREIGN KEY (`id_genero`) REFERENCES `Generos`(`id_genero`)
    ON DELETE SET NULL
    ON UPDATE CASCADE
);

CREATE TABLE `Reviews` (
  `id_review` INT NOT NULL AUTO_INCREMENT,
  `id_utilizador` INT NOT NULL,
  `id_conteudo` INT NOT NULL,
  `data_review` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `classificacao` TINYINT NOT NULL CHECK (`classificacao` BETWEEN 1 AND 10),
  `critica` TEXT NULL,
  `contador_utilidade` INT NOT NULL DEFAULT 0, -- Votos de Utilidade
  PRIMARY KEY (`id_review`),
  FOREIGN KEY (`id_utilizador`) REFERENCES `Utilizadores`(`id_utilizador`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  FOREIGN KEY (`id_conteudo`) REFERENCES `Conteudo`(`id_conteudo`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  UNIQUE KEY `uk_user_content_review` (`id_utilizador`, `id_conteudo`)
);

CREATE TABLE `Favoritos` (
  `id_utilizador` INT NOT NULL,
  `id_conteudo` INT NOT NULL,
  `data_adicionado` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_utilizador`, `id_conteudo`),
  FOREIGN KEY (`id_utilizador`) REFERENCES `Utilizadores`(`id_utilizador`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  FOREIGN KEY (`id_conteudo`) REFERENCES `Conteudo`(`id_conteudo`)
    ON DELETE CASCADE
    ON UPDATE CASCADE
);

CREATE TABLE `Listas_Personalizadas` (
  `id_lista` INT NOT NULL AUTO_INCREMENT,
  `id_utilizador` INT NOT NULL,
  `nome_lista` VARCHAR(100) NOT NULL,
  `descricao` TEXT NULL,
  PRIMARY KEY (`id_lista`),
  FOREIGN KEY (`id_utilizador`) REFERENCES `Utilizadores`(`id_utilizador`)
    ON DELETE CASCADE
    ON UPDATE CASCADE
);

CREATE TABLE `Lista_Conteudos` (
  `id_lista` INT NOT NULL,
  `id_conteudo` INT NOT NULL,
  `ordem` INT NOT NULL,
  PRIMARY KEY (`id_lista`, `id_conteudo`),
  FOREIGN KEY (`id_lista`) REFERENCES `Listas_Personalizadas`(`id_lista`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  FOREIGN KEY (`id_conteudo`) REFERENCES `Conteudo`(`id_conteudo`)
    ON DELETE CASCADE
    ON UPDATE CASCADE
);