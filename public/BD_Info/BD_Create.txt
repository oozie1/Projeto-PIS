DROP SCHEMA IF EXISTS `BD_ProjetoPIS`;
CREATE SCHEMA `BD_ProjetoPIS`;
USE `BD_ProjetoPIS`;

CREATE TABLE `utilizadores` (
  `id_utilizador` int NOT NULL AUTO_INCREMENT,
  `nome_utilizador` varchar(100) NOT NULL,
  `email` varchar(100) NOT NULL,
  `password_hash` varchar(255) NOT NULL,
  `data_registo` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `is_admin` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_utilizador`),
  UNIQUE KEY `email` (`email`)
);

CREATE TABLE `conteudo` (
  `id_conteudo` int NOT NULL AUTO_INCREMENT,
  `tmdb_id` int DEFAULT NULL,
  `tipo` enum('Filme','Serie') NOT NULL,
  `nome` varchar(255) NOT NULL,
  `poster_url` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id_conteudo`),
  UNIQUE KEY `tmdb_id` (`tmdb_id`)
);

CREATE TABLE `favoritos` (
  `id_utilizador` int NOT NULL,
  `id_conteudo` int NOT NULL,
  `data_adicionado` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_utilizador`,`id_conteudo`),
  KEY `id_conteudo` (`id_conteudo`),
  CONSTRAINT `favoritos_ibfk_1` FOREIGN KEY (`id_utilizador`) REFERENCES `utilizadores` (`id_utilizador`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `favoritos_ibfk_2` FOREIGN KEY (`id_conteudo`) REFERENCES `conteudo` (`id_conteudo`) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE `listas_personalizadas` (
  `id_lista` int NOT NULL AUTO_INCREMENT,
  `id_utilizador` int NOT NULL,
  `nome_lista` varchar(100) NOT NULL,
  `descricao` text,
  PRIMARY KEY (`id_lista`),
  KEY `id_utilizador` (`id_utilizador`),
  CONSTRAINT `listas_personalizadas_ibfk_1` FOREIGN KEY (`id_utilizador`) REFERENCES `utilizadores` (`id_utilizador`) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE `lista_conteudos` (
  `id_lista` int NOT NULL,
  `id_conteudo` int NOT NULL,
  `ordem` int NOT NULL,
  PRIMARY KEY (`id_lista`,`id_conteudo`),
  KEY `id_conteudo` (`id_conteudo`),
  CONSTRAINT `lista_conteudos_ibfk_1` FOREIGN KEY (`id_lista`) REFERENCES `listas_personalizadas` (`id_lista`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `lista_conteudos_ibfk_2` FOREIGN KEY (`id_conteudo`) REFERENCES `conteudo` (`id_conteudo`) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE `reviews` (
  `id_review` int NOT NULL AUTO_INCREMENT,
  `id_utilizador` int NOT NULL,
  `id_conteudo` int NOT NULL,
  `data_review` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `classificacao` tinyint NOT NULL,
  `critica` text,
  `contador_utilidade` int NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_review`),
  UNIQUE KEY `uk_user_content_review` (`id_utilizador`,`id_conteudo`),
  KEY `id_conteudo` (`id_conteudo`),
  CONSTRAINT `reviews_ibfk_1` FOREIGN KEY (`id_utilizador`) REFERENCES `utilizadores` (`id_utilizador`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `reviews_ibfk_2` FOREIGN KEY (`id_conteudo`) REFERENCES `conteudo` (`id_conteudo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `reviews_chk_1` CHECK ((`classificacao` between 1 and 10))
);

CREATE TABLE `vistos` (
  `id_visto` int NOT NULL AUTO_INCREMENT,
  `id_utilizador` int NOT NULL,
  `id_conteudo` int NOT NULL,
  `data_visto` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_visto`),
  KEY `id_utilizador` (`id_utilizador`),
  KEY `id_conteudo` (`id_conteudo`),
  CONSTRAINT `vistos_ibfk_1` FOREIGN KEY (`id_utilizador`) REFERENCES `utilizadores` (`id_utilizador`) ON DELETE CASCADE,
  CONSTRAINT `vistos_ibfk_2` FOREIGN KEY (`id_conteudo`) REFERENCES `conteudo` (`id_conteudo`) ON DELETE CASCADE
);