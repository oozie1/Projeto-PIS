<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Início - CineApp</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/styles/index_style.css">
</head>
<body>

    <nav>
        <a href="/" class="logo">CinePIS</a>
        
        <form action="/search" method="GET" class="search-box">
            <input type="text" name="q" placeholder="Pesquisar filmes e séries...">
        </form>

        <div class="auth-links">
            <% if (typeof user !== 'undefined' && user) { %>
                <a href="/auth/perfil" class="user-profile">
                    <i class="fa-solid fa-circle-user user-icon"></i>
                    <span style="font-weight: bold; color: white;"><%= user.nome_utilizador %></span>
                </a>
                <a href="/auth/logout" style="color:#e21c3c; font-weight:bold;">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </a>
            <% } else { %>
                <a href="/auth/login">Entrar</a>
                <a href="/auth/register" style="background: #f5c518; color: black; padding: 6px 15px; border-radius: 50px; font-weight: bold;">Registar</a>
            <% } %>
        </div>
    </nav>

    <div class="filter-bar">
        <form action="/filter" method="GET">
            <select name="genre" class="genre-select" onchange="this.form.submit()">
                <option value="">Todos os Géneros</option>
                <% if (typeof genres !== 'undefined') { %>
                    <% genres.forEach(g => { %>
                        <option value="<%= g.id %>" <%= selectedGenre == g.id ? 'selected' : '' %>>
                            <%= g.name %>
                        </option>
                    <% }) %>
                <% } %>
            </select>
        </form>
    </div>

    <% if (isSearch) { %>
        
        <div class="category-title">
            <% if (selectedGenre && typeof genres !== 'undefined') { %>
                <% const gName = genres.find(g => g.id == selectedGenre)?.name || 'Filtro'; %>
                 Filmes de <%= gName %>
            <% } else { %>
                 Resultados da Pesquisa
            <% } %>
        </div>

        <div class="movie-grid">
            <% if (movies.length > 0) { %>
                <% movies.forEach(movie => { %>
                    <a href="/details/<%= movie.media_type || 'movie' %>/<%= movie.id %>" class="movie-card">
                        <% if (movie.poster_path) { %>
                            <img src="<%= imageBaseUrl + movie.poster_path %>" alt="<%= movie.title || movie.name %>">
                        <% } else { %>
                            <img src="https://via.placeholder.com/160x240?text=Sem+Imagem" alt="Sem Imagem">
                        <% } %>
                        <div class="movie-info"><%= movie.title || movie.name %></div>
                        <div class="rating"><i class="fa-solid fa-star"></i> <%= movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A' %></div>
                    </a>
                <% }) %>
            <% } else { %>
                <p style="padding-left: 40px; grid-column: 1/-1;">Nenhum resultado encontrado.</p>
            <% } %>
        </div>

    <% } else { %>

        <div class="category-title"> Tendências de Hoje</div>
        <div class="movie-row" id="trending-row" data-page="1">
            <% if (typeof trendingMovies !== 'undefined') { %>
                <% trendingMovies.forEach(movie => { %>
                    <a href="/details/<%= movie.media_type || 'movie' %>/<%= movie.id %>" class="movie-card">
                        <% if (movie.poster_path) { %>
                            <img src="<%= imageBaseUrl + movie.poster_path %>" alt="<%= movie.title || movie.name %>">
                        <% } else { %> 
                            <img src="https://via.placeholder.com/160x240" alt="Sem Imagem"> 
                        <% } %>
                        <div class="movie-info"><%= movie.title || movie.name %></div>
                        <div class="rating"><i class="fa-solid fa-star"></i> <%= movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A' %></div>
                    </a>
                <% }) %>
                <div class="load-more-card" onclick="loadMore('trending', 'trending-row', this)">
                    <i class="fa-solid fa-arrow-right load-more-icon"></i>
                </div>
            <% } %>
        </div>

        <div class="category-title"> Filmes Populares</div>
        <div class="movie-row" id="popular-row" data-page="1">
            <% if (typeof popularMovies !== 'undefined') { %>
                <% popularMovies.forEach(movie => { %>
                    <a href="/details/movie/<%= movie.id %>" class="movie-card">
                        <% if (movie.poster_path) { %>
                            <img src="<%= imageBaseUrl + movie.poster_path %>" alt="<%= movie.title %>">
                        <% } %>
                        <div class="movie-info"><%= movie.title %></div>
                        <div class="rating"><i class="fa-solid fa-star"></i> <%= movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A' %></div>
                    </a>
                <% }) %>
                <div class="load-more-card" onclick="loadMore('popular', 'popular-row', this)">
                    <i class="fa-solid fa-arrow-right load-more-icon"></i>
                </div>
            <% } %>
        </div>

        <div class="category-title"> Aclamados pela Crítica</div>
        <div class="movie-row" id="top-row" data-page="1">
            <% if (typeof topRatedMovies !== 'undefined') { %>
                <% topRatedMovies.forEach(movie => { %>
                    <a href="/details/movie/<%= movie.id %>" class="movie-card">
                        <% if (movie.poster_path) { %>
                            <img src="<%= imageBaseUrl + movie.poster_path %>" alt="<%= movie.title %>">
                        <% } %>
                        <div class="movie-info"><%= movie.title %></div>
                        <div class="rating"><i class="fa-solid fa-star"></i> <%= movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A' %></div>
                    </a>
                <% }) %>
                <div class="load-more-card" onclick="loadMore('top_rated', 'top-row', this)">
                    <i class="fa-solid fa-arrow-right load-more-icon"></i>
                </div>
            <% } %>
        </div>

        <div class="category-title" style="margin-top: 60px; border-color: #fff;"> Descobrir Mais Filmes</div>
        <div class="movie-grid" id="discover-movie-grid" data-page="<%= typeof randomPageMovie !== 'undefined' ? randomPageMovie : 1 %>">
            <% if (typeof discoveryMovies !== 'undefined') { %>
                <% discoveryMovies.forEach(movie => { %>
                    <a href="/details/movie/<%= movie.id %>" class="movie-card">
                        <% if (movie.poster_path) { %>
                            <img src="<%= imageBaseUrl + movie.poster_path %>" alt="<%= movie.title %>">
                        <% } else { %>
                            <img src="https://via.placeholder.com/160x240?text=Sem+Imagem" alt="Sem Imagem">
                        <% } %>
                        <div class="movie-info"><%= movie.title %></div>
                        <div class="rating"><i class="fa-solid fa-star"></i> <%= movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A' %></div>
                    </a>
                <% }) %>
            <% } %>
        </div>
        <div class="load-more-container">
            <button class="btn-load-more-circle" onclick="loadMore('discover_movie', 'discover-movie-grid', this)">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

        <div class="category-title" style="margin-top: 60px; border-color: #fff;"> Descobrir Mais Séries</div>
        <div class="movie-grid" id="discover-tv-grid" data-page="<%= typeof randomPageTV !== 'undefined' ? randomPageTV : 1 %>">
            <% if (typeof discoveryTV !== 'undefined') { %>
                <% discoveryTV.forEach(tv => { %>
                    <a href="/details/tv/<%= tv.id %>" class="movie-card">
                        <% if (tv.poster_path) { %>
                            <img src="<%= imageBaseUrl + tv.poster_path %>" alt="<%= tv.name %>">
                        <% } else { %>
                            <img src="https://via.placeholder.com/160x240?text=Sem+Imagem" alt="Sem Imagem">
                        <% } %>
                        <div class="movie-info"><%= tv.name %></div>
                        <div class="rating"><i class="fa-solid fa-star"></i> <%= tv.vote_average ? tv.vote_average.toFixed(1) : 'N/A' %></div>
                    </a>
                <% }) %>
            <% } %>
        </div>
        <div class="load-more-container">
            <button class="btn-load-more-circle" onclick="loadMore('discover_tv', 'discover-tv-grid', this)">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

    <% } %>

    <script src="/js/home.js"></script>

</body>
</html>